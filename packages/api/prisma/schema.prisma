generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String?  @unique
  phone     String?  @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  status    String   @default("active")

  identities Identity[]

  @@map("users")
}

model Identity {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  solanaPublicKey    String   @unique @map("solana_public_key")
  did                String   @unique
  verificationBitmap BigInt   @default(0) @map("verification_bitmap")
  reputationScore    Int      @default(500) @map("reputation_score")
  stakedAmount       BigInt   @default(0) @map("staked_amount")
  metadataUri        String?  @map("metadata_uri")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user                  User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  verificationRequests  VerificationRequest[]
  credentials           Credential[]
  reputationHistory     ReputationHistory[]

  @@index([solanaPublicKey])
  @@index([did])
  @@map("identities")
}

model VerificationRequest {
  id                String    @id @default(uuid())
  identityId        String    @map("identity_id")
  verificationType  String    @map("verification_type")
  status            String    @default("pending")
  requestDataHash   String?   @map("request_data_hash")
  proofHash         String?   @map("proof_hash")
  apiSetuRequestId  String?   @map("api_setu_request_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  completedAt       DateTime? @map("completed_at")
  expiresAt         DateTime? @map("expires_at")

  identity Identity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@index([identityId])
  @@index([status])
  @@map("verification_requests")
}

model Credential {
  id             String    @id @default(uuid())
  credentialId   String    @unique @map("credential_id")
  identityId     String    @map("identity_id")
  issuerId       String?   @map("issuer_id")
  credentialType String    @map("credential_type")
  issuedAt       DateTime  @default(now()) @map("issued_at")
  expiresAt      DateTime? @map("expires_at")
  revoked        Boolean   @default(false)
  revokedAt      DateTime? @map("revoked_at")
  metadataUri    String?   @map("metadata_uri")
  proofHash      String?   @map("proof_hash")

  identity Identity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@index([identityId])
  @@index([credentialType])
  @@map("credentials")
}

model ReputationHistory {
  id          String   @id @default(uuid())
  identityId  String   @map("identity_id")
  eventType   String   @map("event_type")
  scoreDelta  Int      @map("score_delta")
  newScore    Int      @map("new_score")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  identity Identity @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@index([identityId])
  @@index([createdAt])
  @@map("reputation_history")
}

model StakeAccount {
  id              String    @id @default(uuid())
  identityId      String    @map("identity_id")
  solanaAddress   String?   @unique @map("solana_address")
  amount          BigInt
  pendingRewards  BigInt    @default(0) @map("pending_rewards")
  stakedAt        DateTime  @default(now()) @map("staked_at")
  unlockTime      DateTime? @map("unlock_time")
  unstakeRequested DateTime? @map("unstake_requested")
  status          String    @default("active")

  @@index([identityId])
  @@map("stake_accounts")
}

// ============== Authentication & Security ==============

model RefreshToken {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  token       String    @unique
  deviceInfo  String?   @map("device_info")
  ipAddress   String?   @map("ip_address")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")
  isRevoked   Boolean   @default(false) @map("is_revoked")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model ApiKey {
  id          String    @id @default(uuid())
  name        String
  keyHash     String    @unique @map("key_hash")
  userId      String?   @map("user_id")
  permissions String[]  @default([])
  rateLimit   Int       @default(1000) @map("rate_limit")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  isActive    Boolean   @default(true) @map("is_active")

  @@index([keyHash])
  @@map("api_keys")
}

// ============== Audit & Compliance ==============

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resource     String
  resourceId   String?  @map("resource_id")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  requestId    String?  @map("request_id")
  metadata     Json?
  status       String   @default("success")
  errorMessage String?  @map("error_message")
  hash         String?  // HMAC-SHA256 hash for tamper detection
  previousHash String?  @map("previous_hash") // Chain linkage
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([hash])
  @@map("audit_logs")
}

model Consent {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  identityId      String?   @map("identity_id")
  consentType     String    @map("consent_type")
  purpose         String
  dataElements    String[]  @map("data_elements")
  consentArtifact String?   @map("consent_artifact")
  status          String    @default("active")
  version         String    @default("1.0")
  ipAddress       String?   @map("ip_address")
  userAgent       String?   @map("user_agent")
  grantedAt       DateTime  @default(now()) @map("granted_at")
  expiresAt       DateTime? @map("expires_at")
  revokedAt       DateTime? @map("revoked_at")
  revokedReason   String?   @map("revoked_reason")
  isActive        Boolean   @default(true) @map("is_active")

  @@index([userId])
  @@index([identityId])
  @@index([consentType])
  @@index([status])
  @@map("consents")
}

// ============== Data Rights (DPDP Act 2023) ==============

model DataRightsRequest {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  requestType       String    @map("request_type") // access, erasure, correction, portability, grievance
  status            String    @default("pending")
  dataCategories    String[]  @map("data_categories")
  reason            String?
  deadline          DateTime
  processedAt       DateTime? @map("processed_at")
  processedBy       String?   @map("processed_by")
  responseData      Json?     @map("response_data")
  exportFormat      String?   @map("export_format")
  exportFileUrl     String?   @map("export_file_url")

  // Correction-specific
  correctionField   String?   @map("correction_field")
  correctionOldValue String?  @map("correction_old_value")
  correctionNewValue String?  @map("correction_new_value")

  // Grievance-specific
  grievanceCategory String?   @map("grievance_category")
  grievanceDetails  String?   @map("grievance_details")
  grievanceResponse String?   @map("grievance_response")

  ipAddress         String?   @map("ip_address")
  userAgent         String?   @map("user_agent")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([requestType])
  @@index([status])
  @@index([deadline])
  @@map("data_rights_requests")
}

// ============== Aadhaar Access Logging (Aadhaar Act 2016) ==============

model AadhaarAccessLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  identityId   String   @map("identity_id")
  purpose      String   // identity_verification, authentication, e_kyc, etc.
  accessType   String   @map("access_type") // view_masked, decrypt_full, verify, store
  timestamp    DateTime @default(now())
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  consentId    String?  @map("consent_id")
  success      Boolean  @default(true)
  errorMessage String?  @map("error_message")

  @@index([userId])
  @@index([identityId])
  @@index([purpose])
  @@index([timestamp])
  @@map("aadhaar_access_logs")
}

// ============== Privacy Notice & Breach Notification ==============

model PrivacyNotice {
  id            String   @id @default(uuid())
  version       String   @unique
  effectiveDate DateTime @map("effective_date")
  content       Json
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  acknowledgments PrivacyAcknowledgment[]

  @@index([isActive])
  @@index([effectiveDate])
  @@map("privacy_notices")
}

model PrivacyAcknowledgment {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  privacyNoticeId String   @map("privacy_notice_id")
  acknowledgedAt  DateTime @default(now()) @map("acknowledged_at")
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")

  privacyNotice PrivacyNotice @relation(fields: [privacyNoticeId], references: [id])

  @@unique([userId, privacyNoticeId])
  @@index([userId])
  @@index([privacyNoticeId])
  @@map("privacy_acknowledgments")
}

model DataBreach {
  id                String    @id @default(uuid())
  title             String
  description       String
  severity          String    // low, medium, high, critical
  status            String    @default("detected") // detected, investigating, contained, notified_dpdpa, notified_users, resolved
  detectedAt        DateTime  @default(now()) @map("detected_at")
  containedAt       DateTime? @map("contained_at")
  resolvedAt        DateTime? @map("resolved_at")
  affectedUsers     Int       @default(0) @map("affected_users")
  affectedDataTypes String[]  @map("affected_data_types")
  rootCause         String?   @map("root_cause")
  remediation       String?
  dpdpaNotifiedAt   DateTime? @map("dpdpa_notified_at")
  usersNotifiedAt   DateTime? @map("users_notified_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([severity])
  @@index([status])
  @@index([detectedAt])
  @@map("data_breaches")
}

// ============== Oracle Network ==============

model OracleNode {
  id                    String    @id @default(uuid())
  solanaAddress         String    @unique @map("solana_address")
  operatorName          String    @map("operator_name")
  stakeAmount           BigInt    @map("stake_amount")
  status                String    @default("active")
  verificationsSubmitted Int      @default(0) @map("verifications_submitted")
  successfulVerifications Int     @default(0) @map("successful_verifications")
  failedVerifications   Int       @default(0) @map("failed_verifications")
  slashCount            Int       @default(0) @map("slash_count")
  lastActiveAt          DateTime? @map("last_active_at")
  registeredAt          DateTime  @default(now()) @map("registered_at")

  @@index([solanaAddress])
  @@index([status])
  @@map("oracle_nodes")
}

// ============== Rate Limiting ==============

model RateLimitRecord {
  id          String   @id @default(uuid())
  identifier  String   // userId, IP, or API key
  endpoint    String
  count       Int      @default(1)
  windowStart DateTime @map("window_start")
  windowEnd   DateTime @map("window_end")

  @@unique([identifier, endpoint, windowStart])
  @@index([identifier])
  @@index([windowEnd])
  @@map("rate_limit_records")
}

// ============== Encrypted PII Storage ==============

model EncryptedPII {
  id                    String   @id @default(uuid())
  identityId            String   @unique @map("identity_id")

  // Hashes for lookup (HMAC-SHA256)
  aadhaarHash           String?  @unique @map("aadhaar_hash")
  panHash               String?  @unique @map("pan_hash")
  phoneHash             String?  @unique @map("phone_hash")
  emailHash             String?  @unique @map("email_hash")

  // Encrypted fields (AES-256-GCM)
  aadhaarEncrypted      String?  @map("aadhaar_encrypted")
  panEncrypted          String?  @map("pan_encrypted")
  phoneEncrypted        String?  @map("phone_encrypted")
  emailEncrypted        String?  @map("email_encrypted")
  fullNameEncrypted     String?  @map("full_name_encrypted")
  dateOfBirthEncrypted  String?  @map("date_of_birth_encrypted")
  addressEncrypted      String?  @map("address_encrypted")

  // Key management
  encryptionKeyId       String   @map("encryption_key_id")
  keyVersion            Int      @default(1) @map("key_version")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@index([aadhaarHash])
  @@index([panHash])
  @@index([phoneHash])
  @@index([emailHash])
  @@index([encryptionKeyId])
  @@map("encrypted_pii")
}
